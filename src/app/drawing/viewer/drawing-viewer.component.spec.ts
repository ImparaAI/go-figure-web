import { of } from 'rxjs';
import { DebugElement } from '@angular/core';
import { FormsModule } from '@angular/forms';
import { By } from '@angular/platform-browser';
import { MaterialModule } from '@app/material.module';
import { RouterTestingModule } from '@angular/router/testing';
import { ActivatedRoute, RouterModule } from '@angular/router';
import { HAMMER_GESTURE_CONFIG } from '@angular/platform-browser';
import { ComponentFixture, TestBed, async, fakeAsync, tick } from '@angular/core/testing';

import { ApiService } from '@app/api/api.service';
import { Point2D, Point3D } from '@app/structures/point';
import { PatchedGestureConfig } from '@app/gesture-config';
import { DrawingViewerComponent } from './drawing-viewer.component';
import { DraggableCanvasComponent } from '@app/canvas/draggable/draggable-canvas.component';

describe('DrawingViewerComponent', () => {
  let component: DrawingViewerComponent,
      fixture: ComponentFixture<DrawingViewerComponent>,
      canvas: DebugElement,
      apiService = jasmine.createSpyObj('ApiService', ['getDrawing']);

  beforeEach(async(() => {
    TestBed.configureTestingModule({
      declarations: [
        DrawingViewerComponent,
        DraggableCanvasComponent
      ],
      imports: [
        FormsModule,
        MaterialModule,
        RouterTestingModule.withRoutes([]),
      ],
      providers: [
        {provide: ApiService, useValue: apiService},
        {provide: ActivatedRoute, useValue: {snapshot: {paramMap: {get: () => 23}}}},
        {provide: HAMMER_GESTURE_CONFIG, useClass: PatchedGestureConfig}
      ],
    }).compileComponents();
  }));

  beforeEach(() => {
    fixture = TestBed.createComponent(DrawingViewerComponent);
    component = fixture.componentInstance;
    canvas = fixture.debugElement.query(By.css('canvas'));
  });

  it('should look a certain way', fakeAsync(() => {
    let json = {"id":23,"featured":false,"originalPoints":[{"x":253,"y":184,"time":0},{"x":251,"y":171,"time":0.078},{"x":249,"y":159,"time":0.101},{"x":245,"y":140,"time":0.124},{"x":244,"y":132,"time":0.139},{"x":244,"y":128,"time":0.162},{"x":245,"y":121,"time":0.177},{"x":246,"y":112,"time":0.206},{"x":248,"y":105,"time":0.224},{"x":251,"y":98,"time":0.24},{"x":261,"y":89,"time":0.257},{"x":272,"y":82,"time":0.273},{"x":281,"y":79,"time":0.288},{"x":285,"y":79,"time":0.305},{"x":288,"y":80,"time":0.321},{"x":299,"y":91,"time":0.353},{"x":303,"y":100,"time":0.369},{"x":306,"y":109,"time":0.386},{"x":308,"y":119,"time":0.404},{"x":310,"y":132,"time":0.419},{"x":310,"y":140,"time":0.434},{"x":311,"y":147,"time":0.451},{"x":311,"y":153,"time":0.467},{"x":310,"y":158,"time":0.484},{"x":310,"y":159,"time":0.501},{"x":310,"y":161,"time":0.517},{"x":310,"y":162,"time":0.551},{"x":310,"y":162,"time":0.567},{"x":312,"y":159,"time":0.598},{"x":318,"y":152,"time":0.616},{"x":325,"y":144,"time":0.649},{"x":327,"y":141,"time":0.664},{"x":329,"y":139,"time":0.682},{"x":329,"y":139,"time":0.715},{"x":330,"y":139,"time":0.729},{"x":332,"y":142,"time":0.747},{"x":338,"y":150,"time":0.779},{"x":343,"y":157,"time":0.796},{"x":347,"y":163,"time":0.829},{"x":350,"y":165,"time":0.845},{"x":352,"y":165,"time":0.863},{"x":355,"y":163,"time":0.878},{"x":358,"y":160,"time":0.895},{"x":366,"y":148,"time":0.928},{"x":369,"y":144,"time":0.944},{"x":371,"y":141,"time":0.959},{"x":372,"y":138,"time":0.976},{"x":378,"y":136,"time":1.01},{"x":380,"y":136,"time":1.025},{"x":382,"y":135,"time":1.041},{"x":383,"y":135,"time":1.057},{"x":383,"y":136,"time":1.074},{"x":383,"y":136,"time":1.092},{"x":384,"y":138,"time":1.123},{"x":383,"y":141,"time":1.141},{"x":383,"y":144,"time":1.16},{"x":383,"y":150,"time":1.189},{"x":383,"y":154,"time":1.206},{"x":383,"y":156,"time":1.223},{"x":383,"y":158,"time":1.24},{"x":383,"y":159,"time":1.256},{"x":383,"y":160,"time":1.272},{"x":383,"y":161,"time":1.29},{"x":383,"y":162,"time":1.303},{"x":383,"y":163,"time":1.321},{"x":383,"y":163,"time":1.337},{"x":383,"y":164,"time":1.353},{"x":383,"y":164,"time":1.369},{"x":383,"y":165,"time":1.386},{"x":383,"y":164,"time":1.421},{"x":385,"y":161,"time":1.451},{"x":387,"y":156,"time":1.469},{"x":391,"y":146,"time":1.485},{"x":393,"y":141,"time":1.502},{"x":393,"y":128,"time":1.519},{"x":395,"y":118,"time":1.534},{"x":395,"y":111,"time":1.549},{"x":396,"y":107,"time":1.566},{"x":396,"y":103,"time":1.582},{"x":396,"y":100,"time":1.6},{"x":397,"y":98,"time":1.615},{"x":397,"y":96,"time":1.631},{"x":398,"y":94,"time":1.648},{"x":399,"y":92,"time":1.664},{"x":404,"y":91,"time":1.681},{"x":410,"y":91,"time":1.696},{"x":418,"y":90,"time":1.712},{"x":427,"y":91,"time":1.745},{"x":437,"y":93,"time":1.78},{"x":441,"y":95,"time":1.796},{"x":445,"y":98,"time":1.81},{"x":451,"y":105,"time":1.827},{"x":454,"y":109,"time":1.846},{"x":455,"y":112,"time":1.86},{"x":456,"y":114,"time":1.878},{"x":455,"y":122,"time":1.91},{"x":451,"y":136,"time":1.926},{"x":449,"y":143,"time":1.95},{"x":444,"y":156,"time":1.964},{"x":440,"y":169,"time":1.992},{"x":439,"y":172,"time":2.011},{"x":438,"y":177,"time":2.024},{"x":436,"y":182,"time":2.041},{"x":435,"y":191,"time":2.057},{"x":434,"y":194,"time":2.075},{"x":433,"y":197,"time":2.091},{"x":432,"y":199,"time":2.108},{"x":432,"y":200,"time":2.122},{"x":431,"y":202,"time":2.139},{"x":430,"y":203,"time":2.157},{"x":429,"y":204,"time":2.172},{"x":429,"y":205,"time":2.189},{"x":428,"y":206,"time":2.205},{"x":427,"y":207,"time":2.221},{"x":427,"y":207,"time":2.238},{"x":425,"y":208,"time":2.254},{"x":424,"y":209,"time":2.271},{"x":423,"y":211,"time":2.287},{"x":422,"y":211,"time":2.304},{"x":421,"y":212,"time":2.32},{"x":417,"y":214,"time":2.337},{"x":416,"y":215,"time":2.353},{"x":413,"y":216,"time":2.368},{"x":411,"y":217,"time":2.384},{"x":409,"y":218,"time":2.404},{"x":404,"y":220,"time":2.435},{"x":402,"y":221,"time":2.452},{"x":401,"y":222,"time":2.467},{"x":399,"y":224,"time":2.484},{"x":396,"y":230,"time":2.515},{"x":394,"y":234,"time":2.532},{"x":390,"y":241,"time":2.565},{"x":384,"y":252,"time":2.581},{"x":381,"y":264,"time":2.615},{"x":379,"y":269,"time":2.631},{"x":378,"y":276,"time":2.647},{"x":376,"y":284,"time":2.67},{"x":374,"y":292,"time":2.681},{"x":374,"y":295,"time":2.697},{"x":374,"y":298,"time":2.712},{"x":373,"y":300,"time":2.728},{"x":373,"y":301,"time":2.746},{"x":372,"y":303,"time":2.761},{"x":372,"y":304,"time":2.777},{"x":371,"y":306,"time":2.794},{"x":371,"y":307,"time":2.81},{"x":369,"y":308,"time":2.826},{"x":367,"y":310,"time":2.843},{"x":363,"y":312,"time":2.859},{"x":360,"y":314,"time":2.876},{"x":357,"y":315,"time":2.891},{"x":354,"y":317,"time":2.908},{"x":350,"y":318,"time":2.926},{"x":343,"y":320,"time":2.953},{"x":338,"y":320,"time":2.966},{"x":332,"y":321,"time":2.975},{"x":323,"y":321,"time":3.007},{"x":320,"y":321,"time":3.026},{"x":316,"y":321,"time":3.04},{"x":309,"y":320,"time":3.056},{"x":304,"y":318,"time":3.074},{"x":298,"y":313,"time":3.09},{"x":293,"y":308,"time":3.104},{"x":287,"y":303,"time":3.121},{"x":283,"y":298,"time":3.137},{"x":279,"y":292,"time":3.156},{"x":275,"y":287,"time":3.172},{"x":273,"y":282,"time":3.189},{"x":270,"y":276,"time":3.204},{"x":266,"y":269,"time":3.221},{"x":263,"y":261,"time":3.236},{"x":262,"y":257,"time":3.255},{"x":261,"y":254,"time":3.27},{"x":261,"y":251,"time":3.286},{"x":261,"y":251,"time":3.302},{"x":261,"y":248,"time":3.319},{"x":262,"y":246,"time":3.336},{"x":263,"y":243,"time":3.353},{"x":265,"y":241,"time":3.374},{"x":266,"y":239,"time":3.387},{"x":268,"y":237,"time":3.4},{"x":269,"y":235,"time":3.417},{"x":271,"y":233,"time":3.433},{"x":273,"y":227,"time":3.45},{"x":274,"y":223,"time":3.467},{"x":274,"y":218,"time":3.486},{"x":273,"y":216,"time":3.499},{"x":272,"y":212,"time":3.515},{"x":270,"y":209,"time":3.531},{"x":268,"y":206,"time":3.547},{"x":267,"y":204,"time":3.564},{"x":264,"y":202,"time":3.581},{"x":262,"y":200,"time":3.598},{"x":260,"y":199,"time":3.615},{"x":259,"y":197,"time":3.63},{"x":257,"y":196,"time":3.647},{"x":255,"y":195,"time":3.662},{"x":253,"y":194,"time":3.679},{"x":252,"y":193,"time":3.696},{"x":251,"y":191,"time":3.712},{"x":250,"y":190,"time":3.729},{"x":250,"y":189,"time":3.744},{"x":248,"y":186,"time":3.777},{"x":247,"y":185,"time":3.794},{"x":246,"y":182,"time":3.81},{"x":245,"y":176,"time":3.828},{"x":253,"y":184,"time":3.8506274169979693}],"drawVectors":[{"n":0,"real":346.097,"imaginary":187.05199999999988},{"n":1,"real":-82.85491335026566,"imaginary":-0.1308547765242704},{"n":-1,"real":-5.455012015338234,"imaginary":8.402981406051136},{"n":2,"real":-4.938657216477157,"imaginary":-28.36460920893724},{"n":-2,"real":-0.002200232026391691,"imaginary":-14.68308381993927},{"n":3,"real":-4.4310685789434245,"imaginary":2.53342599428833},{"n":-3,"real":0.14684232810794628,"imaginary":-1.1505399993020413},{"n":4,"real":5.755774086569405,"imaginary":3.5419182048526734},{"n":-4,"real":0.6560750443200907,"imaginary":0.7276245793761937},{"n":5,"real":-14.477497519392571,"imaginary":5.83086073430232},{"n":-5,"real":5.811520520006847,"imaginary":1.8015903917985594},{"n":6,"real":0.4857419712837181,"imaginary":5.585429812961179},{"n":-6,"real":-4.539243881287304,"imaginary":1.1019988825099833},{"n":7,"real":-2.4923431382063774,"imaginary":0.463029055929583},{"n":-7,"real":0.6143531092646021,"imaginary":2.3352818091064336},{"n":8,"real":2.85951776669406,"imaginary":3.4640088475275155},{"n":-8,"real":1.3829134065409683,"imaginary":2.2107746551628904},{"n":9,"real":3.692917840589437,"imaginary":1.8205582925302564},{"n":-9,"real":-2.6542885904648625,"imaginary":2.7991735387899097},{"n":10,"real":3.606614678852264,"imaginary":1.0427588171190212},{"n":-10,"real":-0.8201928692086367,"imaginary":-0.16944856736731265},{"n":11,"real":0.8902201842907242,"imaginary":-2.0706895478682212},{"n":-11,"real":0.8360903559269783,"imaginary":-0.00272245019556272},{"n":12,"real":0.5754835635385283,"imaginary":-2.2298533266730134},{"n":-12,"real":0.8440733587284597,"imaginary":-2.423877484509684},{"n":13,"real":-0.7749212650701494,"imaginary":-0.4966746811800203},{"n":-13,"real":0.6622116468950716,"imaginary":1.3169620022776192},{"n":14,"real":0.040140941071942854,"imaginary":-0.16737548339795938},{"n":-14,"real":-0.8434368786068727,"imaginary":0.20379056049414518},{"n":15,"real":0.1824533351106747,"imaginary":-0.4775965842417316},{"n":-15,"real":-0.06857520496889208,"imaginary":0.12438823414634437},{"n":16,"real":-0.231257662673816,"imaginary":0.23307145204151625},{"n":-16,"real":-0.6219462326265004,"imaginary":0.42389638884474456},{"n":17,"real":-0.20279735977464128,"imaginary":-0.013642769853729309},{"n":-17,"real":0.09515409150354476,"imaginary":0.223646750611588},{"n":18,"real":-0.14329254369647274,"imaginary":0.17767721178576604},{"n":-18,"real":0.22310782885056235,"imaginary":0.5970327395947177},{"n":19,"real":0.4426798034439269,"imaginary":0.2852261882603938},{"n":-19,"real":-0.9017289859000851,"imaginary":0.6538743084044969},{"n":20,"real":0.3872250679384329,"imaginary":-0.33975707205883166},{"n":-20,"real":-0.370894359737188,"imaginary":-0.28894299572317855},{"n":21,"real":-0.13232536367977485,"imaginary":0.08069112542509618},{"n":-21,"real":-0.30189184851760664,"imaginary":-0.0319469177143927},{"n":22,"real":0.41168856153606037,"imaginary":-0.04115294251603144},{"n":-22,"real":-0.3338314289446685,"imaginary":-0.47928851033105535},{"n":23,"real":0.2501723419400762,"imaginary":-0.1031601569521754},{"n":-23,"real":-0.018585614958104624,"imaginary":0.009256906723851932},{"n":24,"real":0.3415458716563228,"imaginary":-0.1115440804969999},{"n":-24,"real":-0.1234614500270923,"imaginary":-0.25495488530908317},{"n":25,"real":-0.08910199264762417,"imaginary":-0.38983321475891963},{"n":-25,"real":0.22940769951820544,"imaginary":-0.07363177134795226},{"n":26,"real":0.05577970949506686,"imaginary":-0.12223230296401083},{"n":-26,"real":-0.15522482408943483,"imaginary":-0.07119952286116152},{"n":27,"real":0.07898910505880347,"imaginary":-0.1481696553890502},{"n":-27,"real":-0.22435225419504812,"imaginary":-0.01708563053257331},{"n":28,"real":0.15317180550791787,"imaginary":-0.2244321145080733},{"n":-28,"real":-0.06850855443905124,"imaginary":-0.11487818294143815},{"n":29,"real":0.21402057863738622,"imaginary":-0.18958998615889971},{"n":-29,"real":0.2758811604466625,"imaginary":0.1975077863627807},{"n":30,"real":0.003126607178967955,"imaginary":-0.33393376042421985},{"n":-30,"real":0.046875618378154404,"imaginary":-0.08937677736659239},{"n":31,"real":-0.4370504372675261,"imaginary":-0.0884933146566049},{"n":-31,"real":0.21879768460252952,"imaginary":0.08581864047864696},{"n":32,"real":-0.13985558606956502,"imaginary":-0.2959808738252513},{"n":-32,"real":-0.21422055676184654,"imaginary":-0.05788546982705686},{"n":33,"real":-0.09972581276970369,"imaginary":0.06609718586373728},{"n":-33,"real":0.07135380742200148,"imaginary":0.006061094634202513},{"n":34,"real":0.1404325015655517,"imaginary":0.009924424536346593},{"n":-34,"real":-0.0959753489541551,"imaginary":0.15979130525220256},{"n":35,"real":-0.13084894384496673,"imaginary":0.18240971223519123},{"n":-35,"real":0.0034323427276384266,"imaginary":-0.041479558991328436},{"n":36,"real":0.07852311972483103,"imaginary":0.04810856306277064},{"n":-36,"real":-0.05313696007719798,"imaginary":-0.06248509673251687},{"n":37,"real":-0.15086358950391332,"imaginary":0.052076557183083017},{"n":-37,"real":0.05536570222925935,"imaginary":0.06176475176548338},{"n":38,"real":0.09904503831241976,"imaginary":-0.00152601233531105},{"n":-38,"real":0.18969104621704547,"imaginary":-0.07130814680296993},{"n":39,"real":0.07431431997452503,"imaginary":0.09533709340773869},{"n":-39,"real":-0.06283806083365723,"imaginary":0.028140283862028603},{"n":40,"real":0.1565738938827313,"imaginary":0.07765776707700872}],"calculatedDrawVectorCount":0,"createdAt":"2019-08-16T22:51:46+0000","lastDrawVectorCalculatedAt":null};
    apiService.getDrawing.and.returnValue(Promise.resolve(json));
    fixture.detectChanges();

    expect(component.time).toBe(0);

    tick(2000);

    expect(component.time).toBe(0.6300000000000004);
    expect(canvas.nativeElement.toDataURL()).toBe(require('./t1.json').image);

    tick(2000);

    expect(component.time).toBe(0.2550000000000008);
    expect(canvas.nativeElement.toDataURL()).toBe(require('./t2.json').image);

    /*
     When the canvas changes for whatever reason and the expected values need to be updated, console log the toDataURL() and copy the value into
     the expected json files.
     */
  }));

});